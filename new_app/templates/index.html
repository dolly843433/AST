<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule Engine Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
        }
        .preview {
            background: #f8f9fa;
            padding: 15px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Rule Engine Dashboard</h1>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="#" id="dashboard-link">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="create-rule-link">Create Rule</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="combine-rules-link">Combine Rules</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="evaluate-rule-link">Evaluate Rule</a>
                </li>
            </ul>
        </div>
    </nav>

    <div id="dashboard" class="mt-4">
        <h2>Existing Rules</h2>
        <ul class="list-group" id="rules-list">
            <!-- Dynamic list of rules will be populated here -->
        </ul>
    </div>

    <div id="create-rule" class="mt-4" style="display:none;">
        <h2>Create Rule</h2>
        <div class="form-group">
            <label for="rule-input">Rule String</label>
            <textarea class="form-control" id="rule-input" rows="3"></textarea>
        </div>
        <button class="btn btn-success" id="save-rule">Save Rule</button>
        <button class="btn btn-secondary" id="cancel-create">Cancel</button>
        <h4 class="mt-3">AST Preview:</h4>
        <div class="preview" id="ast-preview"></div>
    </div>

    <div id="combine-rules" class="mt-4" style="display:none;">
        <h2>Combine Rules</h2>
        <div id="rule-checkboxes">
            <!-- Existing rules will be populated here -->
        </div>
        <div class="form-group mt-3">
            <label for="combine-operator">Combine With</label>
            <select class="form-control" id="combine-operator">
                <option>AND</option>
                <option>OR</option>
            </select>
        </div>
        <button class="btn btn-primary" id="combine-rules-button">Combine Rules</button>
        <h4 class="mt-3">Combined Rule Preview:</h4>
        <div class="preview" id="combined-preview"></div>
    </div>

    <div id="evaluate-rule" class="mt-4" style="display:none;">
        <h2>Evaluate Rule</h2>
        <div class="form-group">
            <label for="user-data">User Attributes (JSON format)</label>
            <textarea class="form-control" id="user-data" rows="3"></textarea>
        </div>
        <button class="btn btn-success" id="evaluate-button">Evaluate Rule</button>
        <h4 class="mt-3">Evaluation Result:</h4>
        <div id="evaluation-result" class="preview"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function() {
        // Fetch existing rules on page load
        fetchRules();

        // Navigation
        $('#dashboard-link').click(function() {
            $('#dashboard').show();
            $('#create-rule, #combine-rules, #evaluate-rule').hide();
        });

        $('#create-rule-link').click(function() {
            $('#create-rule').show();
            $('#dashboard, #combine-rules, #evaluate-rule').hide();
        });

        $('#combine-rules-link').click(function() {
            $('#combine-rules').show();
            $('#dashboard, #create-rule, #evaluate-rule').hide();
        });

        $('#evaluate-rule-link').click(function() {
            $('#evaluate-rule').show();
            $('#dashboard, #create-rule, #combine-rules').hide();
        });

        // Save Rule
        $('#save-rule').click(function() {
            const ruleString = $('#rule-input').val();
            $.ajax({
                type: 'POST',
                url: '/create',  // Adjust URL as necessary
                contentType: 'application/json',
                data: JSON.stringify({ rule_string: ruleString }),
                success: function(response) {
                    console.log('jddnsdj')
                    $('#ast-preview').text(JSON.stringify(response.ast, null, 2));
                    fetchRules();  // Refresh the rule list
                },
                error: function(xhr) {
                    alert('Error: ' + xhr.responseJSON.error);
                }
            });
        });

        // Combine Rules
        $('#combine-rules-button').click(function() {
            const selectedRules = [];
            $('input[type="checkbox"]:checked').each(function() {
                selectedRules.push(this.value);
            });
            const operator = $('#combine-operator').val();
            if (!selectedRules || selectedRules.length < 2) {
                alert('Please select at least two rules to combine.');
                return;
            }
            $.ajax({
                type: 'POST',
                url: '/combined',  // Adjust URL as necessary
                contentType: 'application/json',
                data: JSON.stringify({ combined_rules: selectedRules, oprator: operator }),
                success: function(response) {
                    $('#combined-preview').text(JSON.stringify(response.ast, null, 2));
                    fetchRules();  // Refresh the rule list
                },
                error: function(xhr) {
                    alert('Error: ' + xhr.responseJSON.error);
                }
            });
        });

        // Evaluate Rule
        $('#evaluate-button').click(function() {
            const userData = $('#user-data').val();
            let jsonData;
            try {
                jsonData = JSON.parse(userData); // Try to parse the userData
            } catch (error) {
                alert('Invalid JSON format. Please check your input.');
                return;
            }
            $.ajax({
                type: 'POST',
                url: '/evaluate_rule',  // Adjust URL as necessary
                contentType: 'application/json',
                data: JSON.stringify({ ast: jsonData}),
                success: function(response) {
                    $('#evaluation-result').text('Evaluation result: ' + response.result);
                },
                error: function(xhr) {
                    alert('Error: ' + xhr.responseJSON.error);
                }
            });
        });

        // Cancel Create Rule
        $('#cancel-create').click(function() {
            $('#create-rule').hide();
            $('#dashboard').show();
        });

        // Function to fetch existing rules
        function fetchRules() {
            $.ajax({
                type: 'GET',
                url: '/rules/',  // Create an endpoint to get existing rules
                success: function(rules) {
                    $('#rules-list').empty();
                    $('#rule-checkboxes').empty();
                    rules.forEach(function(rule) {
                        $('#rules-list').append(`<li class="list-group-item d-flex justify-content-between align-items-center"><strong>${rule.rule_name}</strong><ul class="list-group ms-3 px-3"><li class="list-group-item">${rule.rule_string}</li></ul></li>`);
                        if(!rule.combined_type){
                            $('#rule-checkboxes').append(`
                                <div class="rule-checkbox">
                                    <input type="checkbox" id="rule-${rule.rule_id}" value="${rule.rule_string}">
                                    <label for="rule-${rule.rule_id}">${rule.rule_name}</label>
                                </div>
                            `);
                        }
                    });
                },
                error: function(xhr) {
                    alert('Error fetching rules: ' + xhr.responseJSON.error);
                }
            });
        }
    });
</script>
</body>
</html>
